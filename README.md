### План курсовой 100%/100%

Изучение области проводимой работы +++

Поиск данных для обучения +++

Выбор модели и подготовка данных +++

Построение и Обучение выбранной модели ++

Проверка работы модели ++

# Курсовая работа

### Применение глубокого обучения в задачах идентификации (распознавания, классификации) орнаментов на памятниках археологи раннего средневековья.

> Выполнил: Студент группы ПИ20-1, Свириденко Максим

## Теоретический анализ области проводимой работы

Материалы изученные при выполнении работы:
#### Орнаменты на памятниках археологи раннего средневековья:

- [ТРАДИЦИОННЫЙ ОРНАМЕНТ ФИННОЯЗЫЧНЫХ НАРОДОВ СЕВЕРО-ЗАПАДНОЙ РОССИИ](https://www.booksite.ru/fulltext/kosm/text.pdf)

- [Классификация в археологии терминологический словарь справочник](https://www.academia.edu/40480564/%D0%9A%D0%BB%D0%B0%D1%81%D1%81%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F_%D0%B2_%D0%B0%D1%80%D1%85%D0%B5%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D0%B8_%D1%82%D0%B5%D1%80%D0%BC%D0%B8%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9_%D1%81%D0%BB%D0%BE%D0%B2%D0%B0%D1%80%D1%8C_%D1%81%D0%BF%D1%80%D0%B0%D0%B2%D0%BE%D1%87%D0%BD%D0%B8%D0%BA)

- [Опорные памятники эпохи раннего средневековья на Северо-Западе Восточной Европы: проблема выделения и попытка конструкции](https://lib.kunstkamera.ru/files/lib/978-5-88431-282-1/978-5-88431-282-1_15.pdf)

- [Особенности орнаментации костяных изделий средневековых памятников Пермского Предуралья](https://cyberleninka.ru/article/n/osobennosti-ornamentatsii-kostyanyh-izdeliy-srednevekovyh-pamyatnikov-permskogo-preduralya/viewer)

- [Цельнолитые щитковые перстни памятников раннего средневековья Пермского Предуралья](https://cyberleninka.ru/article/n/tselnolitye-schitkovye-perstni-pamyatnikov-rannego-srednevekovya-permskogo-preduralya/viewer)

#### CNN и методы глубокого обучения:

- Обучение искусственных нейронных сетей в PyTorch - Материалы Фин. университета. Автор: Сергей Вячеславович Макрушин - Лекция ML №2
- Сверточные нейронные сети - Материалы Фин. университета. Автор: Сергей Вячеславович Макрушин - Лекция ML №4
- [Археологи научили нейросеть классифицировать древнюю керамику](https://www.facebook.com/groups/archaeru/posts/3995516653834796/?locale=zh_CN)
- [Classification of Islamic Geometric Patterns based on Machine Learning Techniques](https://www.researchgate.net/publication/359472668_Classification_of_Islamic_Geometric_Patterns_based_on_Machine_Learning_Techniques)

#### Орнаменты и их классы:

В теме курсовой работы явно не указано какой культурной принадлежности должны быть орнаменты, однако мне удалось составить список:
 - Китайский орнамент - орнамент, основанный на элементах китайской живописи и каллиграфии.
 - Кельтский узел - сложный графический орнамент, который был распространен в раннем средневековье и является одним из самых узнаваемых кельтских орнаментов.
 - Греческий узор - орнамент, состоящий из повторяющихся геометрических фигур, таких как квадраты, треугольники, круги и ромбы.
 - Рунный орнамент - орнамент, основанный на символах рун, которые использовались скандинавами и другими народами Северной Европы в раннем средневековье.

>Для начала мы можем выбрать один из этих видов, но в будущем расширить нашу модель для распознавания и классификации остальных. Так например Китайский орнамент состоит из сложных элементов, по типу драконов, лотосов и т.д. Так что для начала было решено взять самый очевидный и известный вариант - Кельтский узел.

Для кельтского узла раннего средневековья можно предложить следующие классы орнаментов:
 - Клеверы - орнамент, основанный на изображениях трехлистных клеверов, которые были символом святой Троицы в кельтской культуре.
 - Крестики - орнамент, основанный на изображениях кельтских крестов, которые были распространены в христианской и кельтской культуре.
 - Животные - орнамент, основанный на изображениях различных животных, таких как львы, олени, змеи и др., которые были важными символами в кельтской мифологии.
 - Геометрические узоры - орнамент, основанный на различных геометрических фигурах, таких как круги, треугольники, квадраты, ромбы и др.
 - Растительные узоры - орнамент, основанный на изображениях растительных мотивов, таких как листья, ветви, цветы и травы, которые были распространены в кельтской культуре.

Однако Растительные узоры и животные так же слишком сложны, так что скорректируем наш список:
 - Клеверы - орнамент, основанный на изображениях трехлистных клеверов, которые были символом святой Троицы в кельтской культуре.
 - Крестики - орнамент, основанный на изображениях кельтских крестов, которые были распространены в христианской и кельтской культуре.
 - Геометрические узоры - орнамент, основанный на различных геометрических фигурах, таких как круги, треугольники, квадраты, ромбы и др.

<img alt="Кельтский Клевер" height="350" src="/Users/maksim/PycharmProjects/OrnamentRecognitionCNN/data/row/manual/cl-1.png" width="350"/>
<img height="350" src="/Users/maksim/PycharmProjects/OrnamentRecognitionCNN/data/row/manual/kr-1.png" width="350"/>
<img height="200" src="/Users/maksim/PycharmProjects/OrnamentRecognitionCNN/data/row/manual/geo-1.png" width="350"/>


*Изображения взятые из Википедии 1 - Кельтский Клевер; 2 - Крест; 3 - Геометрический узор*

## Работа с данными

#### Поиск данных для обучения

Поиск данных для обучения я совершал несколькими способами:
1. В ручную, поиск по статьям, исследованиям, различным интернет ресурсам (manual)
2. С открытых баз данных, таких как: [Flickr](https://www.flickr.com/photos/), [iStock](https://www.istockphoto.com/), [Pinterest](https://ru.pinterest.com/), [Wikimedia Commons](https://commons.wikimedia.org/), [The British Museum Collection Online](https://www.britishmuseum.org/collection) (database)
3. Использование автоматических инструментов для сбора данных, таких как Google Images или Bing Image Search. (search)

Вследствие чего было сформировано три различных папки данных (по источникам), они были помещены в папку row. Как и ожидалось данных с открытых баз данных удалось собрать больше всего.

Общий дата сет состоит примерно из 115 фотографий, несколько из них является коллажами (2 и более рисунка).

#### Обработка дата-сета

Для начала разобьём все коллажи на отдельные рисунки. После разбиения коллажей мы получаем ~130 изображений, затем нам нужно присвоить каждому изображению свой класс, будем брать данные из источников картинок, а для случаев без явного указания класса определим его сами.
Разметим наши классы в названии файлов:
* cl-N - Клеверы.
* kr-N - Крестики.
* geo-N - Геометрические узоры.
* coll-N - Коллажи, в финальном дата-сете они не участвуют

> В дальнейшем мы можем применить довольно популярный метод расширения нашего дата сета: при создании обучающей выборки мы будем слегка изменять наши изображения, например поворачивать их или отражать. Помимо того что это разнообразит наш дата-сет, это так же улучшает обобщающую способность модели


#### Разделение данных

Затем выделим отдельные папки по классам - cl, kr, geo. И создадим папку valid - это будет папка для валидации модели.

Перед заполнением папки valid, заполним папку test:

По большому счёту все наши изображения можно разделить на три вида: схематичные (только фигура, с однотонным задним фоном), реалистичные (фотографии, фотореалистичные картинки) и артефакты (фотографии предметов, за исключением крестов, на которых изображены символы Кельтских узлов)

В папку test мы заберём 80% всех артефактов, т.к. это задача максимально приближенная к реальности, и несколько реалистичных фотографий для проверки базовых функций модели.

Затем из оставшихся данных, выберем каждую 5-тую фотографию для папки valid, так что бы она составляла 20% от всего дата сета.

Так же пометим наши артефакты как af в названии.

> Как можно заметить из размерности папок, наши классы не сбалансированы, геометрических узоров и клеверов примерно в 2 раза больше крестов, это может повлечь за собой проблемы при дальнейшей работе, такие как: переобучения на более частый класс (склонность модели к большему по объёму классу при предсказании).

#### Загрузка данных и их обработка

Перед началом работы с моделью, давайте сделаем все необходимые импорты, и будем пополнять этот список по мере необходимости:

    import ...

Нам так же нужно определить устройство (физическое) на котором мы можем проводить обучение, стандартным решением является CPU, самый непроизводительный вариант, но он имеется на любом компьютере, ноутбуке и так далее.
Вот все возможные варианты по возрастанию производительности которые поддерживает PyTorch: cpu, mps, cuda.
Вот код, который позволит определить какие устройства доступны для нас:

    # Проверка наличия CUDA (только для GPU NVida) - код взят с официального сайта PyTorch.
    print("cuda:0" if torch.cuda.is_available() else "cpu")
    # Проверка наличия MPS (только для платформы MacOS) - код взят с официального сайта Apple.
    if torch.backends.mps.is_available():
        mps_device = torch.device("mps")
        x = torch.ones(1, device=mps_device)
        print (x)
    else:
        print ("MPS device not found.")
    
    device = torch.device("mps")

В моём случае это mps, так как я работаю на станции MacBook Pro 16'19. Тут же создаём наш device, через который в дальнейшем будем производить все вычисления.

Используем константы и словари для обеспечения гибкости и масштабируемости:

- Задаём константы 
- Создаём трансформаторы данных - В связи с тем что наши картинки имеют разное разрешение, нам нужно стандартизировать их, а так же выполнить базовые преобразования нормализации и получить набор тензоров из наших картинок, для этого идеально подойдёт модуль transforms из torchvision.
- Загружаем данные - Стоит отметить что при загрузке данных наши классы определятся автоматически, благодаря нашему разбиению классов на папки

## Построение и Обучение модели

Изучая материалы по похожим исследованиям, я наткнулся на множество архитектур, и в итоге склоняюсь к архитектуре ResNet с использованием Adam в качестве оптимизатора и категориальную кросс-энтропию (Categorical Cross-Entropy) в качестве функции потерь, так как это что-то среднее между всеми архитектурами которыми я повстречал. На основе работы с этой моделью будем определять все необходимые функции для работы с моделями, а затем рассмотрим ещё 2-3 альтернативных модели, сделаем выводы и определим лучшую.

Так как в дата-сете собранном мной всего около 130 картинок, обучение модели с нуля на таком объёме данных будет не эффективным, по этому возьмём уже обученную модель и видоизменим её финальный слой.

> Мы не должны забывать что наша модель в будущем должна определять более 3-х классов, а так же мы имеем несбалансированные классы, так что будем писать максимально гибкий код, для проверки нескольких вариаций моделей, а затем, если результат нас не устроит, перейдём к созданию более сложной и решающий наши проблемы архитектуре.

#### Определение метрик

При определении метрик мы можем взять стандартный Accuracy, однако он может быть неинформативен для нас так как мы имеем не сбалансированные классы.
К тому же классы geo и cl хоть и имеют отличительные признаки, но схожи между собой, а класс kr зачастую содержит в себе изображения классов geo и cl.
Учитывая всё выше сказанное остановимся на таком списке:
Precision(точность) и Recall(полнота), а так же F1-score, дабы отследить ложно-положительные и ложно-отрицательные результаты классификации, и среднее между ними. А так же Confusion Matrix для понимания какие классы "путаются" больше всего.
Для общей картины так же оставим Accuracy, но не будем опираться на её значение при низких значениях остальных метрик.

    model processing

## Проверка работы модели

#### Строим графики:

 - График ошибки (loss)
 - График точности предсказания (accuracy):
 - График Precision
 - График Recall
 - График F1 Score
 - График Confusion Matrix по валидационным данным
 - График Confusion Matrix по тренировочным данным

#### Выводы по модели ResNet50

После нескольких итераций обучения, судя по графикам accuracy, на 6-7 эпоху модель начинает переобучаться, так как значения при обучении модели повышаются, а при валидации практически не меняются, это значит что на 6-7 эпоху модель приспосабливается к даным для обучения. Так же почти всегда на 6-7 эпоху можно наблюдать скачки в графиках Recall/Precision и F1Score, что свидетельствует о том что наши данные не сбалансированы и модель переобучается на один (или несколько) классов. Если изучить графики Confusion Matrix, то можно убедится в закономерности модели склоняться к несбалансированному классу geo. Судя по графикам Confusion Matrix так же можно наблюдать что зачастую кетки смежные с клеткой geo-geo так же дают больше 1, что свидетельствует о схожести классов geo - cl и geo - kr. Однако значения в клетках kr - cl почти всегда равны 0.

#### Модификация модели ResNet50

Модель имеет ряд проблем:
  * Переобучение на один из классов
  * Схожесть классов geo и cl, а так же классов geo и kr
  * Проблема переобучения модели в целом и её адаптации к тренировочным данным

В основном эти проблемы вызваны несбалансированным дата-сетом. Для решения проблемы схожести классов и дисбаланса в дата-сете, можно применить взвешивание потерь, чтобы модель больше отдавала предпочтение классам cl и kr, между которами модель видит явные различия. А так же понизить скорость обучения модели для предотвращения адаптации к тренировочным данным.

    weight processing

#### Проверка модели ResNet50 на тестовых данных

В среднем модель показывает 96%-89% всех метрик на валидационных данных и 92% - precision; 88% - accuracy на тестовых данных


## Рассмотрим альтернативы

Обучим несколько других моделей на тех же данных.

#### VGG16

VGG16 - это одна из самых известных архитектур свёрточных нейронных сетей. Она так же обучена на дата-сете ImageNet

В среднем модель показывает 99%-95% всех метрик на валидационных данных и 95% - precision; 94% - accuracy на тестовых данных

#### EfficientNet

EfficientNet - это новая архитектура, которая была разработана с целью создания более эффективных свёрточных нейронных сетей.

В среднем модель показывает 37%-26% всех метрик на валидационных данных и 54% - precision; 50% - accuracy на тестовых данных

## Выводы

Модели VGG16 и ResNet50 показали наилучшие результаты, однако точность VGG16 доходит до 100%, что свидетельствует о том что модель VGG16 наиболее эффективна при решении задачи классификации орнаментов раннего средневековья. Дата-сет и кол-во классов можно расширить, и применять модель не только для Кельтских крестов, но и орнаментов других народов.